name: Release
on:
    push:
        tags: ['*']
env:
    GITHUB_TAG: ${{ github.ref }}
jobs:
    tests:
        runs-on: ubuntu-latest
        steps:
            -
                name: Checkout
                uses: actions/checkout@v2.3.4
            -
                name: JVM Tests
                run: ./gradlew jvmTest
    common:
        runs-on: ubuntu-latest
        steps:
            -
                name: Checkout
                uses: actions/checkout@v2.3.4
            -
                name: Configure Java
                uses: actions/setup-java@v2
                with:
                    java-version: 11
                    distribution: adopt-openj9
            -
                name: Build Metadata Publication
                run: ./gradlew publishKotlinMultiplatformPublicationToBuildRepository -Pversion=${GITHUB_TAG/refs\/tags\//}
            -
                name: Build JVM Publication
                run: ./gradlew publishJvmPublicationToBuildRepository -Pversion=${GITHUB_TAG/refs\/tags\//}
            -
                name: Build JS Publication
                run: ./gradlew publishJsPublicationToBuildRepository -Pversion=${GITHUB_TAG/refs\/tags\//}
            -
                name: Maven Publish
                env:
                    GITHUB_TAG: ${{ github.ref }}
                    ORG_GRADLE_PROJECT_mavenUser: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                    ORG_GRADLE_PROJECT_mavenPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                    ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.PGP_INK_CI_KEYID }}
                    ORG_GRADLE_PROJECT_signingKey: ${{ secrets.PGP_INK_CI_PRIVATE }}
                    ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.PGP_INK_CI_PASSWORD }}
                run: >
                    ./gradlew
                    publishKotlinMultiplatformPublicationToMavenCentralRepository
                    publishJvmPublicationToMavenCentralRepository
                    publishJsPublicationToMavenCentralRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}

    linux:
        runs-on: ubuntu-latest
        steps:
            -
                name: Checkout
                uses: actions/checkout@v2.3.4
            -
                name: Configure Java
                uses: actions/setup-java@v2
                with:
                    java-version: 11
                    distribution: adopt-openj9
            -
                name: Build Linux x64 Publication
                run: ./gradlew publishLinuxX64PublicationToBuildRepository -Pversion=${GITHUB_TAG/refs\/tags\//}
            -
                name: Maven Publish
                env:
                    GITHUB_TAG: ${{ github.ref }}
                    ORG_GRADLE_PROJECT_mavenUser: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                    ORG_GRADLE_PROJECT_mavenPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                    ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.PGP_INK_CI_KEYID }}
                    ORG_GRADLE_PROJECT_signingKey: ${{ secrets.PGP_INK_CI_PRIVATE }}
                    ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.PGP_INK_CI_PASSWORD }}
                run: >
                    ./gradlew
                    publishLinuxX64PublicationToMavenCentralRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}

    windows:
        runs-on: windows-latest
        steps:
            -
                name: Checkout
                uses: actions/checkout@v2.3.4
            -
                name: Configure Java
                uses: actions/setup-java@v2
                with:
                    java-version: 11
                    distribution: adopt-openj9
            -
                name: Build Windows X64 Publication
                run: ./gradlew publishMingwX64PublicationToBuildRepository --project-prop version=${GITHUB_TAG/refs\/tags\//}
                shell: bash
            -
                name: Maven Publish
                env:
                    GITHUB_TAG: ${{ github.ref }}
                    ORG_GRADLE_PROJECT_mavenUser: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                    ORG_GRADLE_PROJECT_mavenPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                    ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.PGP_INK_CI_KEYID }}
                    ORG_GRADLE_PROJECT_signingKey: ${{ secrets.PGP_INK_CI_PRIVATE }}
                    ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.PGP_INK_CI_PASSWORD }}
                shell: bash
                run: >
                    ./gradlew
                    publishMingwX64PublicationToMavenCentralRepository
                    --project-prop version=${GITHUB_TAG/refs\/tags\//}
    macos:
        runs-on: macos-latest
        steps:
            -
                name: Checkout
                uses: actions/checkout@v2.3.4
            -
                name: Configure Java
                uses: actions/setup-java@v2
                with:
                    java-version: 11
                    distribution: adopt-openj9
            -
                name: Build iOS Publication
                run: >
                    ./gradlew
                    publishIosArm64PublicationToBuildRepository
                    publishIosX64PublicationToBuildRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}

            -
                name: Build watchOS Publication
                run: >
                    ./gradlew
                    publishWatchosArm32PublicationToBuildRepository
                    publishWatchosArm64PublicationToBuildRepository
                    publishWatchosX64PublicationToBuildRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}

            -
                name: Build tvOS Publication
                run: >
                    ./gradlew
                    publishTvosArm64PublicationToBuildRepository
                    publishTvosX64PublicationToBuildRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}

            -
                name: Build MacOS Publication
                run: >
                    ./gradlew
                    publishMacosX64PublicationToBuildRepository
                    publishMacosArm64PublicationToBuildRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}
            -
                name: Maven Publish
                env:
                    GITHUB_TAG: ${{ github.ref }}
                    ORG_GRADLE_PROJECT_mavenUser: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                    ORG_GRADLE_PROJECT_mavenPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                    ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.PGP_INK_CI_KEYID }}
                    ORG_GRADLE_PROJECT_signingKey: ${{ secrets.PGP_INK_CI_PRIVATE }}
                    ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.PGP_INK_CI_PASSWORD }}
                run: >
                    ./gradlew
                    publishIosArm64PublicationToMavenCentralRepository
                    publishIosX64PublicationToMavenCentralRepository
                    publishWatchosArm32PublicationToMavenCentralRepository
                    publishWatchosArm64PublicationToMavenCentralRepository
                    publishWatchosX64PublicationToMavenCentralRepository
                    publishTvosArm64PublicationToMavenCentralRepository
                    publishTvosX64PublicationToMavenCentralRepository
                    publishMacosX64PublicationToMavenCentralRepository
                    publishMacosArm64PublicationToMavenCentralRepository
                    -Pversion=${GITHUB_TAG/refs\/tags\//}
